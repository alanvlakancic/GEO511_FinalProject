---
title: "Euclidean Bus Mobility and Route Optimization, A Comparison"
author: "Alan Vlakancic"
subtitle: "Routes in Queens, New York City, NY"
date: today
date-format: long
format:
  html:
    toc: true
    code-fold: true
    fig-width: 10
    fig-height: 8
editor: visual
---

# Introduction
This project will use stplanr transport modeling package to design an optimal transport route for bus or cycle routes in New York City. Stplanr is a transport planning visualization R package that can be used to plan transit networks, in addition to transit planning elements such as identifying transit catchment areas, origin/destination data and ride frequency visualizations, among others.  In their white paper, the devlopers of stplanr call for an accountable, transparent and democratized transit planning system that doesn’t rely on proprietary and often vastly different data sources and data processing softwares. Although the package can visualize a whole host of data, this project will focus on comparing direct desire lines or “Euclidean” routes (as the crow flies), existing bus networks and stplanr’s optimized routes. To wit: this can map the efficiency of the bus routes compared to the most direct route possible if there were no built environment factors in the way.


# Methods

To adequately compare desire lines, bus routes, and the most efficient routes with the current street network, this project will require at minimum three data sources. Each of these will be sourced separately and overlaid onto each other:

- **Data Source:** ggmap data for basemap  
  - **Methods:** This can be sourced directly into R by installing the package. ggmap can bring in data from Stadiamaps. This will require a Google API key to be registered.  
  - **Source:** [Getting Started with ggmap & Stadiamaps](https://docs.stadiamaps.com/tutorials/getting-started-in-r-with-ggmap/)

- **Data Source:** OpenStreetMap data for transit data, either bus or cycle routes  
  - **Methods:** This can be sourced directly into R by installing the package. You may need to rationalize different projection systems to make sure they overlay correctly.  
  - **Source:** [Mapping with OpenStreetMap in R](https://ajsmit.github.io/Intro_R_Official/mapping-google.html)

- **Data Source:** NYC Open Data for Bus Shelter locations  
  Despite significant searching, there is no comprehensive bus stop dataset, so the project will focus on bus stop shelters, which are mapped via NYC Open Data.  
  - **Methods:** This can be brought into R as a CSV file. Each bus stop shelter has longitude and latitude coordinates that align with ggmap and OpenStreetMap projections.  
  - **Source:** [NYC Bus Stop Shelters](https://data.cityofnewyork.us/Transportation/Bus-Stop-Shelters/qafz-7myz)

# Workflow:
````{r, eval=FALSE}
install.packages("ggmap")
install.packages("stplanr")
install.packages("osmdata")
install.packages("sf")
install.packages("dodgr")
library(ggmap)
library(stplanr)
library(osmdata)
library(sf)
library(tidyverse)
library(dodgr)

#this workflow includes map tests to ensure the data is working

queens_bbox <- c(left = -73.96, bottom = 40.54, right = -73.70, top = 40.81)

ggmap::register_stadiamaps(key = "324ab7fd-26ce-4b7d-924b-38f00bc9f021")
nyc_map <- get_stadiamap(
  bbox = queens_bbox,
  zoom = 10,
  maptype = "stamen_toner"
)
ggmap(nyc_map)
#googling identifies that this is in WGS 84

shelters_sf <- read_csv("data/Bus_Stop_Shelter_20251020.csv")
#download and import bus shelters

shelters_sf_fix <- st_as_sf(shelters_sf, coords = c("Longitude", "Latitude"), crs = 4326)
#convert to sf (simple feature) object with the correct coordinate reference system

ggmap(nyc_map) +
  geom_sf(data = shelters_sf_fix, inherit.aes = FALSE, color = "blue", size = .5)
#plot shelters on the map

osm_queens <- opq(bbox = queens_bbox) %>%
  add_osm_feature(key = "highway", value = c("primary", "secondary")) %>%
  osmdata_sf()
#import osm data

shelters_sf_fix <- shelters_sf_fix %>%
  mutate(id = paste0("S", row_number()))
# add ID column for origin-destination pairs

flow_all <- expand.grid(
  o = shelters_sf_fix$id,
  d = shelters_sf_fix$id,
  stringsAsFactors = FALSE
) %>%
  filter(o != d) %>%              # this remove self-pairs
  mutate(trips = 1)
# create origin-destination pairs with a trip count of 1

flow_all <- sample_n(flow_all, 500)
# sample 500 random pairs to reduce computation

desire_lines_all <- od2line(flow_all, zones = shelters_sf_fix, zone_code = "id")
# create desire lines for all pairs


desire_plot <- ggmap(nyc_map) +
  geom_sf(data = osm_queens$osm_lines, inherit.aes = FALSE,
          color = "gray60", size = 0.3, alpha = 0.6) +
  geom_sf(data = desire_lines_all, inherit.aes = FALSE,
          color = "red", size = 0.3, alpha = 0.5) +
  geom_sf(data = shelters_sf_fix, inherit.aes = FALSE,
          color = "blue", size = 1) +
  ggtitle("Desire Lines Between All Bus Shelters in Queens")
# plot desire lines along with roads and shelters

plot(desire_plot)


````
# Figure
![](images/desire_lines_queens.png){caption="Bus Shelters in Queens" }
# Questions
- Naturally, a silhouette instead of the Stadia map would be more attractive, if there's one you can suggest.
- I am struggling to figure out how to use the Open Street Map data (osm) as a 'route' for stplanr to analyze. It's currently just a sf, so it's not a vector.
  - The dodgr package does this, I just have not figured it out yet.
- Looking to do something that looks like this: 
  - ![Desire Lines vs Actual Routes](https://user-images.githubusercontent.com/1825120/142071229-81358e26-5e8d-437e-9ef8-91704a4e690f.png)
