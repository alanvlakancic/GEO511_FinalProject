[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Euclidean Bus Mobility and Route Optimization, A Comparison",
    "section": "",
    "text": "Introduction\nThis project uses stplanr transport modeling package to design an optimal transport route for bus or cycle routes in New York City. Stplanr is a transport planning visualization R package that can be used to plan transit networks, in addition to transit planning elements such as identifying transit catchment areas, origin/destination data and ride frequency visualizations, among others. In their white paper, the devlopers of stplanr call for an accountable, transparent and democratized transit planning system that doesn’t rely on proprietary and often vastly different data sources and data processing softwares. Although the package can visualize a whole host of data, this project will focus on comparing direct desire lines or “Euclidean” routes (as the crow flies), existing bus networks and stplanr’s optimized routes. To wit: this can map the efficiency of the bus routes compared to the most direct route possible if there were no built environment factors in the way.\n\n\nMethods\nTo adequately compare desire lines, bus routes, and the most efficient routes with the current street network, this project will require at minimum three data sources. Each of these will be sourced separately and overlaid onto each other:\n\nData Source: leaflet data for basemap\n\nMethods: This can be sourced directly into R by installing the leaflet package. It provides an interactive background map that can be used to overlay other spatial data, and the options can be toggled on and off for ease of use.\nSource: Leaflet for R\n\nData Source: OpenStreetMap (OSMR) data for transit data, either bus or cycle routes, this is used as the route vector data.\n\nMethods: This can be sourced directly into R by installing the package. You may need to rationalize different projection systems to make sure they overlay correctly.\n\nSource: Mapping with OpenStreetMap in R\n\nData Source: NYC Open Data for Bus Shelter locations\nDespite significant searching, there is no comprehensive bus stop dataset, so the project will focus on bus stop shelters, which are mapped via NYC Open Data. I used Bus Shelters as there would be thousands upon thousands of bus stops in NYC, and this would be too computationally intensive to process.\n\n\nMethods: This can be brought into R as a CSV file. Each bus stop shelter has longitude and latitude coordinates that align with leaflet and OpenStreetMap projections.\n\nSource: NYC Bus Stop Shelters, NYC Transit analysis\n\nData Source: NYC Open Data for NYC Borough Boundaries\n\nMethods: This can be brought into R as a shapefile. This will provide the basemap boundary for NYC to ensure all data is within the city limits.\nSource: NYC Borough Boundaries, Department of City Planning\n\n\n\n\nData Preparation\n\nLoad the necessary R packages for spatial data manipulation and visualization (e.g., ggmap, dplyr, stplanr, osmdata, sf, leaflet).\nImport the NYC basemap shapefile and bus shelter CSV data into R.\nConvert the bus shelter data into an sf object with appropriate coordinate reference system (CRS).\n\n\n\nTerms:\n\nDesire Lines & “Euclidean”: Straight lines connecting origin and destination points, representing the most direct path between them.\nOSRM: Open Street Routing Machine, a routing engine that uses Open Street Map data to calculate routes, shortest routes, travel times, and can be used to make travel time maps, distance routing for car, bike and walking.\n\n\n\nInteractive Map:\n\n\nShow code\n#install libraries\nlibrary(ggmap) #vestigial\nlibrary(dplyr) #data manipulation\nlibrary(stplanr) #od2line calculation, origin-destination programming\nlibrary(osmdata) #open street maps data\nlibrary(sf) #spatial data\nlibrary(tidyverse) #data manipulation\nlibrary(leaflet) #interactive map\nlibrary(purrr) #for map2 function\nlibrary(kableExtra) #for attractive table formatting\nlibrary(scales) #for comma function\n\n\n\n\nShow code\n#SHAPEFILES AND MAP\n\nbbox &lt;- c(left = -73.96, bottom = 40.54, right = -73.70, top = 40.81)\n#create bounding box for NYC\n\nnyc_map &lt;- \"data/\"#\n\n#nyc basemap, downloaded from nyc open data. source: https://search.r-project.org/CRAN/refmans/ptools/html/nyc_bor.html\n\nnyc_sf &lt;- st_read(nyc_map, quiet =TRUE)\n#bring in nyc_map as a sf\n\nshelters_sf &lt;- read_csv(\"data/Bus_Stop_Shelter_20251020.csv\")\n#NOTE: REPLACE WITH DATA WHEN USING QUARTO!\n#this brings in the bus stop shelter information. source: https://data.cityofnewyork.us/Transportation/Bus-Stop-Shelters/qafz-7myz\n\nshelters_sf_fix &lt;- st_as_sf(shelters_sf, coords = c(\"Longitude\",\"Latitude\"), crs = 4326)\n#convert to sf object with the correct coordinate reference system\n\nosmdata::set_overpass_url(\"https://overpass-api.de/api/interpreter\")\n#set overpass url for open street maps, finds specific data package, the below query will use this\n\nosm_data &lt;- opq(bbox = bbox) %&gt;%\n  add_osm_feature(key = \"highway\", value = c(\"primary\",\"secondary\")) %&gt;%\n  osmdata_sf()\n#import data for primary and secondary highways from open street maps\n#opq is overpass query, which is basically where you want to look\n\n\n\n\nShow code\n# STPLANR FUNCTIONS\n\nshelters_sf_fix &lt;- shelters_sf_fix %&gt;%\n  mutate(id = paste0(\"S\", row_number()))\n#add ID column for origin-destination pairs so they have a corresponding number\n\nflow_all &lt;- expand.grid(o = shelters_sf_fix$id, #create origin\n                        d = shelters_sf_fix$id, #create destination\n                        stringsAsFactors = FALSE) %&gt;% #make sure they aren't factors\n  filter(o != d) %&gt;% # this remove self-pairs so O is not D\n  mutate(trips = 1) %&gt;% #add trip count of 1 for each pair\n  sample_n(50) #sample 50 random paris to avoid blowing up the computer\n\ndesire_lines_all &lt;- od2line(flow_all, zones = shelters_sf_fix, zone_code = \"id\") #use od2line function to create desire lines (euclidean) for all pairs\n\nshelter_coords &lt;- shelters_sf_fix %&gt;%\n  st_coordinates() %&gt;%\n  as.data.frame() %&gt;%\n  bind_cols(id = shelters_sf_fix$id)\n#extract coordinates and bind with ID column\n\nroute_single &lt;- function(o_id, d_id) { #function to create a single route between origin and destination\n  o &lt;- shelter_coords %&gt;% filter(id == o_id) \n  #filter to get origin coordinates\n  d &lt;- shelter_coords %&gt;% filter(id == d_id)\n  #filter to get destination coordinates\n\n  r &lt;- try(route_osrm(from = c(o$X, o$Y),\n                      to   = c(d$X, d$Y)), silent = TRUE)\n#use try to catch errors  (e.g., no route found)\n  if (inherits(r, \"try-error\")) return(NULL)\n#if route found, return the route\n  return(r)\n}\n\nroutes_list &lt;- purrr::map2(flow_all$o, flow_all$d, route_single)\n#create routes for all origin-destination pairs using the route_single function\nroutes_list &lt;- routes_list[!sapply(routes_list, is.null)]\n#remove any NULL results (failed routes)\nroutes_sf &lt;- do.call(rbind, routes_list)\n#combine all routes into a single sf object\n\n\n\n\nShow code\n#ROUTE & DESIRE LENGTH CALCULATION, MEAN & PCT CHANGE\n\nroutes_projection &lt;- st_transform(routes_sf, 32618)\ndesire_projection &lt;- st_transform(desire_lines_all, 32618)\n#ensures the correct, projected shapefile for computation not mapping\n\nroute_length &lt;- st_length(routes_projection)\ndesire_length &lt;- st_length(desire_projection)\n#compute lengths\n\nroute_length &lt;- as.numeric(route_length)\ndesire_length &lt;- as.numeric(desire_length)\n#convert lengths to numeric values\n\nlengths_tbl &lt;- tibble(\n  route_m  = route_length,\n  desire_m = desire_length,\n  origin = flow_all$o,\n  destination = flow_all$d\n)\n#create tibble to compare lengths in the final map w/ IDs\n\nlengths_tbl_print &lt;- tibble(\n  route_m  = comma(round(route_length)),\n  desire_m = comma(round(desire_length)),\n  origin = flow_all$o,\n  destination = flow_all$d\n)\n#tidy data for later printing in a kable\n\nmean_route &lt;- mean(route_length, na.rm = TRUE)\nmean_desire &lt;- mean(desire_length, na.rm = TRUE)\n#calculate means for both route and desire lengths\n\npercent_change &lt;- ((mean_route - mean_desire) / mean_desire) * 100\n#calculate percent change \n\nmean_lengths &lt;- data.frame(\n  type = c(\"Route Length\", \"Desire Line Length\"),\n  mean_length_m = c(round(mean_route), round(mean_desire)))\n\n#put these into a data frame, rounded to whole numbers\n\n\nmean_lengths &lt;- mean_lengths %&gt;%\n  mutate(\n    mean_length_km = mean_length_m / 1000,\n    percent_change = c(percent_change, NA)\n  )\n#add km conversion and percent change to the data frame, i converted to KM for ease of computation (ie: dividing by 1,000)\n\nmean_lengths_print &lt;- mean_lengths %&gt;%\n  mutate(\n    mean_length_km = comma(round(mean_length_m / 1000)),\n    percent_change = comma(round(percent_change))\n  )\n#tidy data for later printing in a kable\n\n\n\n\nShow code\n#LEAFLET PREP\n\nnyc_leaflet  &lt;- st_transform(nyc_sf, 4326)\nroads_leaflet &lt;- st_transform(osm_data$osm_lines, 4326)\ndesire_leaflet &lt;- st_transform(desire_lines_all, 4326)\nroutes_leaflet &lt;- st_transform(routes_sf, 4326)\n#transform all data to WGS84 for leaflet mapping\n\ndesire_leaflet_popup &lt;- paste0(\n  \"&lt;b&gt;Desire Line&lt;/b&gt;&lt;br/&gt;\",\n  \"Origin: \", desire_leaflet$o, \"&lt;br/&gt;\",\n  \"Destination: \", desire_leaflet$d, \"&lt;br/&gt;\",\n  \"Desire Line Distance: \", round(lengths_tbl$desire_m / 1000), \" km\"\n)\n#create popup info for desire lines for interactive map\n  \nroutes_leaflet_popup &lt;- paste0(\n  \"&lt;b&gt;OSRM Route&lt;/b&gt;&lt;br/&gt;\",\n  \"Origin: \", desire_leaflet$o, \"&lt;br/&gt;\",\n  \"Destination: \", desire_leaflet$d, \"&lt;br/&gt;\",\n  \"Route Distance: \", round(lengths_tbl$route_m / 1000), \" km&lt;br/&gt;\"\n)\n#create popup info for routes for interactive map\n\npal_desire &lt;- colorNumeric(\n  palette = \"viridis\",\n  domain  = lengths_tbl$desire_m\n)\n#create color palette for desire lines based on distance\n\npal_routes &lt;- colorNumeric(\n  palette = \"inferno\",\n  domain  = lengths_tbl$route_m\n)\n#create color palette for routes based on distance\n\nselected_ids &lt;- unique(c(flow_all$o, flow_all$d))\n#get unique IDs of sampled shelters\n\nselected_shelters &lt;- shelters_sf_fix %&gt;% \n  filter(id %in% selected_ids)\n#filter shelters to only those that were sampled\n\n\n\n\nShow code\n#LEAFLET MAP\n\nleaflet() %&gt;%\n  addProviderTiles(\"CartoDB.Positron\") %&gt;%\n  \n  addPolygons(data = nyc_leaflet,\n              color = \"black\", weight = 3,\n              fillOpacity = 0.1,\n              group = \"NYC Boundary\") %&gt;%\n  # Add OSM roads w/ positron background\n  \n  addPolylines(\n    data = desire_leaflet,\n    color = pal_desire(lengths_tbl$desire_m),\n    weight = 3,\n    opacity = 0.7,\n    popup = desire_leaflet_popup,\n    group = \"Desire Lines\"\n  ) %&gt;%\n  \n  addPolylines(\n    data = routes_leaflet,\n    color = pal_routes(lengths_tbl$route_m),\n    weight = 3,\n    opacity = 0.8,\n    popup = routes_leaflet_popup,\n    group = \"OSRM Routes\"\n  ) %&gt;%\n  \n  addLegend(\n    pal = pal_desire,\n    values = lengths_tbl$desire_m,\n    title = \"Desire Line Distance (m)\",\n    position = \"bottomright\",\n    group = \"Desire Lines\"\n  ) %&gt;%\n  #add a legend for desire lines\n  addLegend(\n    pal = pal_routes,\n    values = lengths_tbl$route_m,\n    title = \"OSRM Route Distance (m)\",\n    position = \"bottomleft\",\n    group = \"OSRM Routes\"\n  ) %&gt;%\n  #add a legend for osrm routes\n\n    addCircleMarkers(data = shelters_sf_fix,\n                   color = \"blue\",\n                   radius = 1,\n                   popup = ~id,\n                   group = \"Bus Shelters\") %&gt;%\n  #add all bus shelters\n  addCircleMarkers(\n    data = selected_shelters,\n    color = \"purple\",\n    radius = 6,\n    fillOpacity = 0.9,\n    group = \"Sampled Shelters\"\n  ) %&gt;%\n  #add sampled bus shelters with purple markers\n  addLayersControl(\n    overlayGroups = c(\"NYC Boundary\", \"Sampled Shelters\",\n                      \"Desire Lines\", \"OSRM Routes\",\n                      \"Bus Shelters\"),\n    options = layersControlOptions(collapsed = FALSE)\n  )\n\n\n\n\n\n\n\n\nTables:\n\n\nShow code\nmean_lengths_print %&gt;%\n  kable(col.names = c(\"Type\", \"Mean Length (m)\", \"Mean Length (km)\", \"Percent Change (%)\"),\n        caption = \"Mean Lengths of OSRM Routes vs Desire Lines\") %&gt;%\n  kable_styling(full_width = FALSE, position = \"left\")\n\n\n\nMean Lengths of OSRM Routes vs Desire Lines\n\n\nType\nMean Length (m)\nMean Length (km)\nPercent Change (%)\n\n\n\n\nRoute Length\n18495\n18\n24\n\n\nDesire Line Length\n14883\n15\nNA\n\n\n\n\n\n\n\n\n\nShow code\nlengths_tbl_print %&gt;%\n  kable(col.names = c(\"Route Length (m)\", \"Desire Line Length (m)\", \"Origin ID\", \"Destination ID\"),\n        caption = \"Comparison of Route Lengths and Desire Line Lengths for Sampled Origin-Destination Pairs\") %&gt;%\n  kable_styling(full_width = FALSE, position = \"left\")\n\n\n\nComparison of Route Lengths and Desire Line Lengths for Sampled Origin-Destination Pairs\n\n\nRoute Length (m)\nDesire Line Length (m)\nOrigin ID\nDestination ID\n\n\n\n\n3,222\n2,571\nS469\nS451\n\n\n16,870\n11,093\nS1708\nS2522\n\n\n15,190\n13,561\nS879\nS297\n\n\n28,745\n25,158\nS900\nS1355\n\n\n19,374\n17,485\nS2232\nS2668\n\n\n11,932\n9,488\nS2182\nS1029\n\n\n18,712\n15,999\nS1104\nS1707\n\n\n35,698\n27,245\nS992\nS292\n\n\n8,075\n6,235\nS2865\nS1317\n\n\n32,959\n21,873\nS1078\nS2666\n\n\n29,226\n24,524\nS2913\nS2261\n\n\n19,698\n17,183\nS2896\nS667\n\n\n25,982\n22,626\nS834\nS964\n\n\n8,647\n6,845\nS50\nS2576\n\n\n6,013\n5,287\nS426\nS1843\n\n\n12,327\n10,880\nS1966\nS2874\n\n\n22,964\n10,001\nS2820\nS1038\n\n\n19,683\n14,326\nS2501\nS2342\n\n\n16,348\n14,004\nS2386\nS2563\n\n\n23,423\n20,394\nS171\nS2416\n\n\n24,451\n15,595\nS3152\nS1080\n\n\n33,602\n9,761\nS418\nS3337\n\n\n8,318\n7,461\nS3162\nS2919\n\n\n21,735\n16,438\nS2651\nS1088\n\n\n14,096\n12,445\nS319\nS2327\n\n\n7,880\n7,054\nS1899\nS2937\n\n\n39,562\n37,136\nS3361\nS1460\n\n\n20,993\n17,919\nS262\nS1283\n\n\n20,604\n12,059\nS2895\nS954\n\n\n29,836\n26,339\nS1279\nS24\n\n\n2,546\n1,993\nS722\nS78\n\n\n12,822\n10,614\nS2505\nS2594\n\n\n4,998\n4,810\nS1571\nS1675\n\n\n8,678\n7,484\nS2580\nS2957\n\n\n8,738\n7,338\nS1314\nS1146\n\n\n8,537\n7,928\nS208\nS894\n\n\n24,940\n22,271\nS3167\nS2143\n\n\n27,794\n24,405\nS3299\nS3043\n\n\n19,430\n15,656\nS169\nS1216\n\n\n15,104\n12,305\nS2356\nS633\n\n\n18,870\n13,620\nS2603\nS2176\n\n\n11,021\n7,846\nS1267\nS2399\n\n\n36,977\n34,530\nS3259\nS1531\n\n\n22,052\n19,959\nS1816\nS2789\n\n\n17,855\n16,619\nS893\nS1289\n\n\n22,629\n20,027\nS889\nS1838\n\n\n34,323\n28,387\nS2532\nS3241\n\n\n16,506\n15,383\nS2929\nS2137\n\n\n5,437\n5,208\nS1922\nS1466\n\n\n9,319\n8,786\nS2431\nS2469\n\n\n\n\n\n\n\n\n\nResults\nThe mean route length for the optimized routes for this particular sample run is 18.49 km, while the mean Euclidean desire line length is 14.88 km. This represents a percent change of 24.27% longer for the optimized routes compared to the direct desire lines. The interactive map above visualizes these routes, with desire lines colored based on their lengths and Open Street Routing Machine (OSRM) routes similarly colored with a different theme.\n\n\nDiscussion\nThe results indicate that the optimized OSRM routes are significantly longer than the direct desire lines, which is generally expected given the constraints of the built environment and road network. The percent change of 24.27% suggests that while the desire lines represent the most direct path between two points, real-world travel must navigate around obstacles, follow roadways, and adhere to traffic regulations etc.\n\n\nLimitations\n\nThis does not represent all bus stops in NYC, just shelters. Although the exact number of bus stops is difficult to find, the MTA states that there are 327 bus routes in the five boroughs and countless stops in between. To make the data manageable both in computation and visualization, this study only selects 50 at random. This limits the amount of data points and does not fully capture the bus network.\nThe OSRM routing service may not always find a route between two points, especially if they are very close together or in areas with limited road connectivity. The code removes these unroutable routes, and they are not shown in the data.\nThe analysis does not account for real-world factors such as traffic, hazards, closures, road conditions, bus “bunching” or transit schedules, which can significantly impact actual travel times and route efficiency.The analysis assumes that the shortest path is the most efficient, which may not always be the case in real-world scenarios.\nThe sample size of 50 origin-destination pairs is relatively small and is not be representative of the entire bus network in NYC.\nOnly “Primary” and “Secondary” roads are sampled here, as the computation for the smaller roads (tertiary etc.) was too processing heavy. This eliminates a large selection of routes.\n\n\n\nFuture:\nFuture research could expand the sample size to include more origin-destination pairs, or even all bus stops. Incorporating real-world travel time data, traffic patterns, and transit schedules could provide a more comprehensive understanding of route efficiency. Further analysis could also explore the impact of different modes of transportation, such as cycling or walking, on route optimization and efficiency.\n\n\nReferences\n\nA. J. Smit. Mapping with Google in R. Source.\nCRAN. stplanr Paper and Vignettes. Source.\nNYC Open Data. Bus Stop Shelters Dataset. Source.\nRobin Lovelace. stplanr: R Package Documentation. Source.\nopenstreetmap.de. OpenStreetMap Routing Service. Source.\nRStudio. Leaflet for R. Source.\nMTA. New York City Transit Subway and Bus Facts 2019. Source.\nNYC.gov. NYC Borough Boundaries Dataset. Source."
  },
  {
    "objectID": "index.html#download-and-clean-all-required-data",
    "href": "index.html#download-and-clean-all-required-data",
    "title": "Analyzing Urban Mobility Patterns Using stplanr",
    "section": "Download and clean all required data",
    "text": "Download and clean all required data\n\n\nCode\nn=20\ndata=data.frame(x=runif(n,-180,180),\n                y=runif(n,-60,60),\n                size = runif(n, 5, 20),\n                category = factor(\n                  sample(letters[1:5], n, replace = TRUE)\n                  ),\n                value = rnorm(n))\n\n\n\nCode\ndata %&gt;% \n  slice(1:10) %&gt;% #show only 1:n rows\n  kable(digits=2,align=\"c\")%&gt;% #make table and round to two digits\n  kable_styling(bootstrap_options = \n                  c(\"striped\", \"hover\", \"condensed\", \"responsive\")) #apply other formatting\n\n\n\n\n\nx\ny\nsize\ncategory\nvalue\n\n\n\n\n148.18\n-28.60\n6.17\nd\n-0.37\n\n\n54.02\n23.81\n6.32\ne\n-0.41\n\n\n165.83\n-13.85\n16.35\nd\n-1.73\n\n\n174.36\n23.91\n10.55\ne\n-0.48\n\n\n116.50\n-56.81\n18.17\nd\n-0.33\n\n\n-160.48\n42.96\n5.84\na\n1.03\n\n\n35.39\n-59.37\n11.03\ne\n-1.58\n\n\n-169.40\n23.57\n12.64\nb\n-0.11\n\n\n-114.45\n58.58\n19.67\nc\n1.39\n\n\n-30.02\n-42.35\n16.95\nc\n0.09\n\n\n\n\n\n\nAdd any additional processing steps here."
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "About this site\n\n\nShow code\n1 + 1\n\n\n[1] 2"
  },
  {
    "objectID": "data/Readme.html",
    "href": "data/Readme.html",
    "title": "Data Folder",
    "section": "",
    "text": "Data Folder\nPlace any data needed by your analysis in this folder. Please do not store large files here. Then read in any data using the ‘data’ path. For example, read_csv(\"data/data.csv\")."
  }
]